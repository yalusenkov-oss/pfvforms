// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PFVMUSIC Complete System - Final Version Ñ Telegram
// Ğ”Ğ¸ÑÑ‚Ñ€Ğ¸Ğ±ÑƒÑ†Ğ¸Ñ + ĞŸÑ€Ğ¾Ğ¼Ğ¾ + ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹ + Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ¾Ğ² + ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ + Telegram
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸
const SPREADSHEET_ID = SpreadsheetApp.getActiveSpreadsheet().getId();
const DISTRIBUTION_SHEET_NAME = 'Ğ”Ğ¸ÑÑ‚Ñ€Ğ¸Ğ±ÑƒÑ†Ğ¸Ñ';
const PROMO_SHEET_NAME = 'ĞŸÑ€Ğ¾Ğ¼Ğ¾';
const PROMO_CODES_SHEET_NAME = 'ĞŸÑ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹';

// ID ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ° Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°
const TEMPLATE_ID = '1MD0F4Ie0WQMCbZxHuwa0v23p836TFNV36MSEVbhBY7g';
// ID Ñ„Ğ°Ğ¹Ğ»Ğ° Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸ Ğ² Google Drive
const SIGNATURE_FILE_ID = '19Ot12RgTizoTHUitr6Sl7SiiEZ0ZAoXn';

// ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Telegram ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
const TELEGRAM_CONFIG = {
  ENABLED: false,              // â† Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ true Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğ¹
  BOT_TOKEN: '',               // â† Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ° (Ğ¾Ñ‚ @BotFather)
  CHAT_ID: '',                 // â† Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ ID Ñ‡Ğ°Ñ‚Ğ°/ĞºĞ°Ğ½Ğ°Ğ»Ğ°
  THREAD_ID: null,             // â† ID Ñ‚Ğ¾Ğ¿Ğ¸ĞºĞ° (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾, Ğ´Ğ»Ñ ÑÑƒĞ¿ĞµÑ€Ğ³Ñ€ÑƒĞ¿Ğ¿)
  DEBUG_MODE: false,           // â† true Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ»Ğ°Ğ´ĞºĞ¸
  NOTIFY_DISTRIBUTION: true,   // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°Ñ…
  NOTIFY_PROMO: true,          // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ¾ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ¿Ñ€Ğ¾Ğ¼Ğ¾
  NOTIFY_PROMO_CODE: false,    // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğ°Ñ…
  NOTIFY_DOC_GENERATED: true   // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ ĞºĞ¾Ğ³Ğ´Ğ° Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ»Ğ¸ÑÑ‚Ğ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initializeSheets() {
  const spreadsheet = SpreadsheetApp.openById(SPREADSHEET_ID);

  let distributionSheet = spreadsheet.getSheetByName(DISTRIBUTION_SHEET_NAME);
  if (!distributionSheet) {
    distributionSheet = spreadsheet.insertSheet(DISTRIBUTION_SHEET_NAME);
  }
  setupDistributionSheet(distributionSheet);

  let promoSheet = spreadsheet.getSheetByName(PROMO_SHEET_NAME);
  if (!promoSheet) {
    promoSheet = spreadsheet.insertSheet(PROMO_SHEET_NAME);
  }
  setupPromoSheet(promoSheet);

  let promoCodesSheet = spreadsheet.getSheetByName(PROMO_CODES_SHEET_NAME);
  if (!promoCodesSheet) {
    promoCodesSheet = spreadsheet.insertSheet(PROMO_CODES_SHEET_NAME);
  }
  setupPromoCodesSheet(promoCodesSheet);
}

function setupDistributionSheet(sheet) {
  const headers = [
    'timestamp', 'tariff', 'release_type', 'track_count', 'work_title',
    'pseudonym', 'release_version', 'release_link', 'genre', 'language',
    'release_date', 'cover_link', 'tiktok_excerpt', 'tiktok_full', 'yandex_presave',
    'karaoke', 'tracks_json', 'licensor_name', 'passport_series_number', 'passport_issued_by',
    'passport_issue_date', 'bank_details', 'email', 'contact', 'artist_profile_links',
    'base_price', 'karaoke_price', 'total_price', 'contract_number', 'percentage',
    'contract_status', 'music_author', 'lyrics_author', 'document_status'
  ];

  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#4A90E2');
  headerRange.setFontColor('#FFFFFF');
  headerRange.setHorizontalAlignment('center');
  headerRange.setVerticalAlignment('middle');
  headerRange.setWrap(true);

  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 120);
  sheet.setColumnWidth(3, 120);
  sheet.setColumnWidth(4, 100);
  sheet.setColumnWidth(5, 200);
  sheet.setColumnWidth(6, 150);
  sheet.setColumnWidth(17, 250);
  sheet.setColumnWidth(18, 200);
  sheet.setFrozenRows(1);

  Logger.log('Distribution sheet configured');
}

function setupPromoSheet(sheet) {
  const headers = [
    'timestamp', 'Type', 'release_link', 'upc_or_name', 'release_date',
    'genre', 'focus_track', 'additional_info', 'artist_and_title', 'release_description',
    'artist_info', 'artist_photos', 'social_links', 'contact_info', 'status'
  ];

  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#E27D60');
  headerRange.setFontColor('#FFFFFF');
  headerRange.setHorizontalAlignment('center');
  headerRange.setVerticalAlignment('middle');
  headerRange.setWrap(true);

  sheet.setColumnWidth(1, 150);
  sheet.setColumnWidth(2, 120);
  for (let i = 3; i <= headers.length; i++) {
    sheet.setColumnWidth(i, 180);
  }
  sheet.setFrozenRows(1);

  Logger.log('Promo sheet configured');
}

function setupPromoCodesSheet(sheet) {
  const headers = [
    'id', 'code', 'discount_type', 'discount_value', 'applicable_tariffs',
    'applicable_release_types', 'max_uses', 'current_uses', 'is_active',
    'valid_from', 'valid_until', 'created_at', 'description'
  ];

  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#9B59B6');
  headerRange.setFontColor('#FFFFFF');
  headerRange.setHorizontalAlignment('center');
  headerRange.setVerticalAlignment('middle');
  headerRange.setWrap(true);

  sheet.setFrozenRows(1);
  Logger.log('Promo codes sheet configured');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° POST/GET Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function doPost(e) {
  try {
    if (!e) throw new Error('No request data received');

    let data;
    if (e.postData && e.postData.contents) {
      data = JSON.parse(e.postData.contents);
    } else if (e.parameter && e.parameter.data) {
      data = JSON.parse(e.parameter.data);
    } else {
      throw new Error('No data received');
    }

    if (data.action === 'update') {
      updateRowData(data);
    } else if (data.action === 'promo_code_delete') {
      deletePromoCode(data);
    } else if (data.formType === 'promo_code') {
      savePromoCode(data);
    } else if (data.formType === 'distribution') {
      saveDistribution(data);
    } else if (data.formType === 'promo') {
      savePromo(data);
    } else {
      throw new Error('Unknown formType or action: ' + (data.formType || data.action || 'undefined'));
    }

    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹',
        formType: data.formType,
        action: data.action
      }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    Logger.log('doPost error: ' + error.toString());
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        error: error.toString(),
        stack: error.stack
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

function doGet(e) {
  if (!e) e = { parameter: {} };
  if (!e.parameter) e.parameter = {};

  if (e.parameter.action === 'list') {
    try {
      const sheetParam = e.parameter.sheet || '';
      const limit = e.parameter.limit ? parseInt(String(e.parameter.limit), 10) : null;
      const rows = listSheetRows(sheetParam, limit);
      return ContentService
        .createTextOutput(JSON.stringify({ rows: rows }))
        .setMimeType(ContentService.MimeType.JSON);
    } catch (error) {
      Logger.log('doGet list error: ' + error.toString());
      return ContentService
        .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }

  if (e.parameter.data) {
    try {
      const dataString = decodeURIComponent(e.parameter.data);
      const data = JSON.parse(dataString);

      if (data.action === 'update') {
        updateRowData(data);
      } else if (data.action === 'promo_code_delete') {
        deletePromoCode(data);
      } else if (data.formType === 'promo_code') {
        savePromoCode(data);
      } else if (data.formType === 'distribution') {
        saveDistribution(data);
      } else if (data.formType === 'promo') {
        savePromo(data);
      } else {
        throw new Error('Unknown formType or action');
      }

      return ContentService
        .createTextOutput(JSON.stringify({
          success: true,
          message: 'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹',
          formType: data.formType,
          action: data.action
        }))
        .setMimeType(ContentService.MimeType.JSON);
    } catch (error) {
      return ContentService
        .createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
        .setMimeType(ContentService.MimeType.JSON);
    }
  }

  return ContentService
    .createTextOutput(JSON.stringify({
      status: 'ok',
      message: 'PFVMUSIC API is running',
      info: 'Use ?action=list&sheet=distributions to get data',
      hasParameters: !!(e && e.parameter && Object.keys(e.parameter).length > 0)
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function saveDistribution(data) {
  try {
    initializeSheets();
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(DISTRIBUTION_SHEET_NAME);
    if (!sheet) throw new Error('Sheet "' + DISTRIBUTION_SHEET_NAME + '" not found');

    const contractNumber = generateContractNumber();
    const percentage = getTariffPercentage(data.tariff);

    const row = [
      new Date(data.timestamp || new Date()),
      getTariffName(data.tariff),
      getReleaseTypeName(data.releaseType),
      data.trackCount || 0,
      data.releaseName || '',
      data.mainArtist || '',
      data.releaseVersion || '',
      data.releaseLink || '',
      data.genre || '',
      data.language || '',
      data.releaseDate || '',
      data.coverLink || '',
      data.tiktokExcerpt || '',
      data.tiktokFull || '',
      data.yandexPreSave || '',
      data.addKaraoke === 'yes' ? 'Ğ”Ğ°' : 'ĞĞµÑ‚',
      JSON.stringify(data.tracks || []),
      data.fullName || '',
      data.passportNumber || '',
      data.issuedBy || '',
      data.issueDate || '',
      data.bankDetails || '',
      data.email || '',
      data.contactInfo || '',
      data.artistProfileLinks || '',
      Number(data.basePrice || 0),
      Number(data.karaokePrice || 0),
      Number(data.totalPrice || 0),
      contractNumber,
      percentage + '%',
      '',
      data.musicAuthor || '',
      data.lyricsAuthor || '',
      ''
    ];

    sheet.appendRow(row);

    const lastRow = sheet.getLastRow();
    if (lastRow % 2 === 0) {
      sheet.getRange(lastRow, 1, 1, row.length).setBackground('#F9F9F9');
    }
    try {
      sheet.getRange(lastRow, 26, 1, 3).setNumberFormat('#,##0 â‚½');
    } catch (e) {
      Logger.log('Skip number format: ' + e);
    }

    Logger.log('Distribution data saved successfully. Contract: ' + contractNumber);

    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ² Telegram
    if (TELEGRAM_CONFIG.ENABLED && TELEGRAM_CONFIG.NOTIFY_DISTRIBUTION) {
      sendDistributionNotification({
        contractNumber: contractNumber,
        licensorName: data.fullName || '',
        pseudonym: data.mainArtist || '',
        tariff: getTariffName(data.tariff),
        releaseType: getReleaseTypeName(data.releaseType),
        releaseDate: data.releaseDate || '',
        workTitle: data.releaseName || '',
        musicAuthor: data.musicAuthor || data.fullName || '',
        lyricsAuthor: data.lyricsAuthor || data.fullName || '',
        email: data.email || '',
        contact: data.contactInfo || '',
        sheetUrl: SpreadsheetApp.getActiveSpreadsheet().getUrl()
      });
    }

  } catch (error) {
    Logger.log('saveDistribution error: ' + error.toString());
    throw error;
  }
}

function savePromo(data) {
  try {
    initializeSheets();
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(PROMO_SHEET_NAME);
    if (!sheet) throw new Error('Sheet "' + PROMO_SHEET_NAME + '" not found');

    const row = [
      new Date(data.timestamp || new Date()),
      getPromoTypeName(data.promoType),
      data.releaseLink || '',
      data.upcOrName || '',
      data.releaseDate || '',
      data.genre || '',
      data.focusTrack || '',
      data.additionalInfo || '',
      data.artistAndTitle || '',
      data.releaseDescription || '',
      data.artistInfo || '',
      data.artistPhotos || '',
      data.socialLinks || '',
      data.contactInfo || '',
      data.status || ''
    ];

    sheet.appendRow(row);

    const lastRow = sheet.getLastRow();
    if (lastRow % 2 === 0) {
      sheet.getRange(lastRow, 1, 1, row.length).setBackground('#FFF5E6');
    }

    Logger.log('Promo data saved successfully. Type: ' + data.promoType);

    // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ² Telegram
    if (TELEGRAM_CONFIG.ENABLED && TELEGRAM_CONFIG.NOTIFY_PROMO) {
      sendPromoNotification({
        promoType: getPromoTypeName(data.promoType),
        releaseLink: data.releaseLink || '',
        upcOrName: data.upcOrName || '',
        releaseDate: data.releaseDate || '',
        genre: data.genre || '',
        focusTrack: data.focusTrack || '',
        artistAndTitle: data.artistAndTitle || '',
        contactInfo: data.contactInfo || '',
        sheetUrl: SpreadsheetApp.getActiveSpreadsheet().getUrl()
      });
    }

  } catch (error) {
    Logger.log('savePromo error: ' + error.toString());
    throw error;
  }
}

function savePromoCode(data) {
  try {
    initializeSheets();
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(PROMO_CODES_SHEET_NAME);
    if (!sheet) throw new Error('Sheet "' + PROMO_CODES_SHEET_NAME + '" not found');

    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const id = data.id || ('PC-' + Math.random().toString(36).substring(2, 8).toUpperCase());
    const existingRow = findRowById(sheet, headers, id);

    const row = [
      id,
      data.code || '',
      data.discountType || 'percent',
      data.discountValue || 0,
      (data.applicableTariffs || []).join(', '),
      (data.applicableReleaseTypes || []).join(', '),
      data.maxUses || 0,
      data.currentUses || 0,
      data.isActive === false ? false : true,
      data.validFrom || '',
      data.validUntil || '',
      data.createdAt || new Date().toISOString(),
      data.description || ''
    ];

    if (existingRow > 1) {
      sheet.getRange(existingRow, 1, 1, row.length).setValues([row]);
      Logger.log('Promo code updated: ' + id);
    } else {
      sheet.appendRow(row);
      Logger.log('Promo code created: ' + id);

      // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ² Telegram Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸
      if (TELEGRAM_CONFIG.ENABLED && TELEGRAM_CONFIG.NOTIFY_PROMO_CODE) {
        sendPromoCodeNotification({
          id: id,
          code: data.code || '',
          discountType: data.discountType || 'percent',
          discountValue: data.discountValue || 0,
          description: data.description || '',
          sheetUrl: SpreadsheetApp.getActiveSpreadsheet().getUrl()
        });
      }
    }
  } catch (error) {
    Logger.log('savePromoCode error: ' + error.toString());
    throw error;
  }
}

function deletePromoCode(data) {
  try {
    initializeSheets();
    const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(PROMO_CODES_SHEET_NAME);
    if (!sheet) throw new Error('Sheet "' + PROMO_CODES_SHEET_NAME + '" not found');

    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    const id = data.id || '';
    const rowNum = findRowById(sheet, headers, id);

    if (rowNum > 1) {
      sheet.deleteRow(rowNum);
      Logger.log('Promo code deleted: ' + id);
    } else {
      throw new Error('Promo code not found: ' + id);
    }
  } catch (error) {
    Logger.log('deletePromoCode error: ' + error.toString());
    throw error;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ“Ğ•ĞĞ•Ğ ĞĞ¦Ğ˜Ğ¯ Ğ›Ğ˜Ğ¦Ğ•ĞĞ—Ğ˜ĞĞĞĞ«Ğ¥ Ğ”ĞĞšĞ£ĞœĞ•ĞĞ¢ĞĞ’
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateLicenseDocuments() {
  try {
    const templateId = TEMPLATE_ID;
    Logger.log("ID ÑˆĞ°Ğ±Ğ»Ğ¾Ğ½Ğ°:", templateId);

    const templateFile = DriveApp.getFileById(templateId);
    if (!templateFile) {
      throw new Error("Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ Ñ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ½Ñ‹Ğ¼ ID Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ TEMPLATE_ID.");
    }
    Logger.log("Ğ¨Ğ°Ğ±Ğ»Ğ¾Ğ½ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½:", templateFile.getName());

    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(DISTRIBUTION_SHEET_NAME);
    if (!sheet) {
      throw new Error("ĞĞµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ»Ğ¸ÑÑ‚ '" + DISTRIBUTION_SHEET_NAME + "'");
    }
    Logger.log("Ğ›Ğ¸ÑÑ‚ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½:", sheet.getName());

    const rows = sheet.getDataRange().getValues();
    const headers = rows[0];
    Logger.log("Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ ÑÑ‚Ğ¾Ğ»Ğ±Ñ†Ğ¾Ğ²:", headers);

    const indices = {
      contractNumber: headers.indexOf("contract_number"),
      licensorName: headers.indexOf("licensor_name"),
      tariff: headers.indexOf("tariff"),
      passportSeriesNumber: headers.indexOf("passport_series_number"),
      passportIssuedBy: headers.indexOf("passport_issued_by"),
      passportIssueDate: headers.indexOf("passport_issue_date"),
      bankDetails: headers.indexOf("bank_details"),
      email: headers.indexOf("email"),
      pseudonym: headers.indexOf("pseudonym"),
      workTitle: headers.indexOf("work_title"),
      musicAuthor: headers.indexOf("music_author"),
      lyricsAuthor: headers.indexOf("lyrics_author"),
      documentStatus: headers.indexOf("document_status")
    };

    Logger.log("Ğ˜Ğ½Ğ´ĞµĞºÑÑ‹ ÑÑ‚Ğ¾Ğ»Ğ±Ñ†Ğ¾Ğ²:", indices);

    for (let key in indices) {
      if (indices[key] < 0) {
        throw new Error(`Ğ¡Ñ‚Ğ¾Ğ»Ğ±ĞµÑ† '${key}' Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñ‹.`);
      }
    }

    const currentDate = new Date();
    const formattedDate = formatDate(currentDate);

    const futureDate = new Date();
    futureDate.setFullYear(currentDate.getFullYear() + 4);
    const formattedFutureDate = formatDate(futureDate);

    let processedCount = 0;

    rows.slice(1).forEach((row, index) => {
      const rowIndex = index + 2;
      Logger.log(`ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° ÑÑ‚Ñ€Ğ¾ĞºĞ¸ ${rowIndex}`);

      if (row[indices.documentStatus] === "Completed") {
        Logger.log(`Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° ${rowIndex} ÑƒĞ¶Ğµ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ°. ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞº.`);
        return;
      }

      const contractNumber = row[indices.contractNumber];
      if (!contractNumber) {
        Logger.log(`Ğ¡Ñ‚Ñ€Ğ¾ĞºĞ° ${rowIndex}: Ğ½ĞµÑ‚ Ğ½Ğ¾Ğ¼ĞµÑ€Ğ° Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ°. ĞŸÑ€Ğ¾Ğ¿ÑƒÑĞº.`);
        return;
      }

      const licensorName = row[indices.licensorName] || 'Ğ‘ĞµĞ· Ğ¸Ğ¼ĞµĞ½Ğ¸';
      const fileName = `Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ â„–${contractNumber} - ${licensorName}`;
      Logger.log(`Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ°: ${fileName}`);

      try {
        const docCopy = templateFile.makeCopy(fileName);
        Utilities.sleep(2000);

        const doc = DocumentApp.openById(docCopy.getId());
        const body = doc.getBody();

        const tariff = row[indices.tariff] || '';
        Logger.log(`Ğ¢Ğ°Ñ€Ğ¸Ñ„ Ğ´Ğ»Ñ ÑÑ‚Ñ€Ğ¾ĞºĞ¸ ${rowIndex}: ${tariff}`);

        let percentageText = '';
        switch (tariff) {
          case 'Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹':
            percentageText = '55% (ĞŸÑÑ‚ÑŒĞ´ĞµÑÑÑ‚ Ğ¿ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ¾Ğ²)';
            break;
          case 'ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹':
            percentageText = '70% (Ğ¡ĞµĞ¼ÑŒĞ´ĞµÑÑÑ‚ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ¾Ğ²)';
            break;
          case 'ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼':
            percentageText = '90% (Ğ”ĞµĞ²ÑĞ½Ğ¾ÑÑ‚Ğ¾ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ¾Ğ²)';
            break;
          case 'ĞŸĞ»Ğ°Ñ‚Ğ¸Ğ½ÑƒĞ¼':
            percentageText = '95% (Ğ”ĞµĞ²ÑĞ½Ğ¾ÑÑ‚Ğ¾ Ğ¿ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ¾Ğ²)';
            break;
          default:
            percentageText = '55% (ĞŸÑÑ‚ÑŒĞ´ĞµÑÑÑ‚ Ğ¿ÑÑ‚ÑŒ Ğ¿Ñ€Ğ¾Ñ†ĞµĞ½Ñ‚Ğ¾Ğ²)';
        }

        const replacements = {
          '{{contract_number}}': contractNumber,
          '{{licensor_name}}': licensorName,
          '{{date}}': formattedDate,
          '{{future_date}}': formattedFutureDate,
          '{{percentage}}': percentageText,
          '{{passport_series_number}}': row[indices.passportSeriesNumber] || '',
          '{{passport_issued_by}}': row[indices.passportIssuedBy] || '',
          '{{passport_issue_date}}': row[indices.passportIssueDate] || '',
          '{{bank_details}}': row[indices.bankDetails] || '',
          '{{email}}': row[indices.email] || '',
          '{{pseudonym}}': row[indices.pseudonym] || '',
          '{{work_title}}': row[indices.workTitle] || '',
          '{{music_author}}': row[indices.musicAuthor] || '',
          '{{lyrics_author}}': row[indices.lyricsAuthor] || ''
        };

        Logger.log("Ğ—Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¼ĞµĞ½Ñ‹:", replacements);

        for (let marker in replacements) {
          body.replaceText(marker, replacements[marker]);
        }

        replaceInTables(body, replacements);
        insertSignature(body);
        doc.saveAndClose();

        Logger.log(`Ğ”Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚ Ğ´Ğ»Ñ ${fileName} ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½.`);
        sheet.getRange(rowIndex, indices.documentStatus + 1).setValue("Completed");
        processedCount++;

        // ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ½Ğ¾Ğ¼ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğµ
        if (TELEGRAM_CONFIG.ENABLED && TELEGRAM_CONFIG.NOTIFY_DOC_GENERATED) {
          const docUrl = docCopy.getUrl();
          sendDocumentGeneratedNotification({
            contractNumber: contractNumber,
            licensorName: licensorName,
            pseudonym: row[indices.pseudonym] || '',
            workTitle: row[indices.workTitle] || '',
            docUrl: docUrl
          });
        }

      } catch (docError) {
        Logger.log(`ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ° Ğ´Ğ»Ñ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ğ° â„–${contractNumber}: ${docError.message}`);
        sheet.getRange(rowIndex, indices.documentStatus + 1).setValue("Error: " + docError.message);
      }
    });

    Logger.log(`ĞŸÑ€Ğ¾Ñ†ĞµÑÑ ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ² Ğ·Ğ°Ğ²ĞµÑ€ÑˆÑ‘Ğ½. ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ğ½Ğ¾ ÑÑ‚Ñ€Ğ¾Ğº: ${processedCount}`);

    SpreadsheetApp.getActiveSpreadsheet().toast(
      `Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²: ${processedCount}`,
      'Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞµĞ½Ğ°',
      5
    );

  } catch (error) {
    Logger.log("ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ¾ÑˆĞ»Ğ° Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: " + error.message);
    SpreadsheetApp.getActiveSpreadsheet().toast(
      error.message,
      'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ³ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğ¾Ğ²',
      10
    );
  }
}

function replaceInTables(body, replacements) {
  const tables = body.getTables();
  tables.forEach(table => {
    for (let r = 0; r < table.getNumRows(); r++) {
      const row = table.getRow(r);
      for (let c = 0; c < row.getNumCells(); c++) {
        const cell = row.getCell(c);
        for (let marker in replacements) {
          cell.replaceText(marker, replacements[marker]);
        }
      }
    }
  });
}

function formatDate(date) {
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  return `${day}.${month}.${year}`;
}

function insertSignature(body) {
  try {
    const marker = '{{signature_or}}';
    const range = body.findText(marker);
    if (!range) {
      Logger.log('ĞœĞ°Ñ€ĞºĞµÑ€ {{signature_or}} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ Ğ² Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğµ');
      return;
    }

    const el = range.getElement();
    const text = el.asText();
    const start = range.getStartOffset();
    const end = range.getEndOffsetInclusive();

    text.deleteText(start, end);

    const blob = DriveApp.getFileById(SIGNATURE_FILE_ID).getBlob();
    const parent = el.getParent();

    if (parent && parent.insertInlineImage) {
      const img = parent.insertInlineImage(parent.getChildIndex(el) + 1, blob);
      img.setWidth(200);
      Logger.log('ĞŸĞ¾Ğ´Ğ¿Ğ¸ÑÑŒ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾ Ğ²ÑÑ‚Ğ°Ğ²Ğ»ĞµĞ½Ğ°');
    } else {
      Logger.log('ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ²ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑÑŒ: Ñ€Ğ¾Ğ´Ğ¸Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğ¹ ÑĞ»ĞµĞ¼ĞµĞ½Ñ‚ Ğ½Ğµ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¸Ğ·Ğ¾Ğ±Ñ€Ğ°Ğ¶ĞµĞ½Ğ¸Ñ');
    }
  } catch (error) {
    Logger.log('ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸ Ğ²ÑÑ‚Ğ°Ğ²ĞºĞµ Ğ¿Ğ¾Ğ´Ğ¿Ğ¸ÑĞ¸: ' + error.toString());
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TELEGRAM Ğ£Ğ’Ğ•Ğ”ĞĞœĞ›Ğ•ĞĞ˜Ğ¯
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function sendDistributionNotification(data) {
  if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) {
    return;
  }

  try {
    const message = buildDistributionMessage(data);
    const result = sendToTelegramAPI(message);

    if (!result.ok) {
      throw new Error(result.description || "ĞÑˆĞ¸Ğ±ĞºĞ° Telegram API");
    }

    Logger.log("âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ´Ğ¸ÑÑ‚Ñ€Ğ¸Ğ±ÑƒÑ†Ğ¸Ğ¸ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾");
  } catch (error) {
    Logger.log("ğŸš¨ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Telegram: " + error.message);
    if (TELEGRAM_CONFIG.DEBUG_MODE) {
      sendDebugInfo("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ´Ğ¸ÑÑ‚Ñ€Ğ¸Ğ±ÑƒÑ†Ğ¸Ğ¸: " + error.message);
    }
  }
}

function sendPromoNotification(data) {
  if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) {
    return;
  }

  try {
    const message = buildPromoMessage(data);
    const result = sendToTelegramAPI(message);

    if (!result.ok) {
      throw new Error(result.description || "ĞÑˆĞ¸Ğ±ĞºĞ° Telegram API");
    }

    Logger.log("âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾");
  } catch (error) {
    Logger.log("ğŸš¨ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Telegram: " + error.message);
    if (TELEGRAM_CONFIG.DEBUG_MODE) {
      sendDebugInfo("ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾: " + error.message);
    }
  }
}

function sendPromoCodeNotification(data) {
  if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) {
    return;
  }

  try {
    const message = buildPromoCodeMessage(data);
    const result = sendToTelegramAPI(message);

    if (!result.ok) {
      throw new Error(result.description || "ĞÑˆĞ¸Ğ±ĞºĞ° Telegram API");
    }

    Logger.log("âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾");
  } catch (error) {
    Logger.log("ğŸš¨ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Telegram: " + error.message);
  }
}

function sendDocumentGeneratedNotification(data) {
  if (!TELEGRAM_CONFIG.ENABLED || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) {
    return;
  }

  try {
    const message = buildDocumentMessage(data);
    const result = sendToTelegramAPI(message);

    if (!result.ok) {
      throw new Error(result.description || "ĞÑˆĞ¸Ğ±ĞºĞ° Telegram API");
    }

    Logger.log("âœ… Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾ Ğ´Ğ¾ĞºÑƒĞ¼ĞµĞ½Ñ‚Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾");
  } catch (error) {
    Logger.log("ğŸš¨ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Telegram: " + error.message);
  }
}

function buildDistributionMessage(data) {
  const escapeMd = (text) => {
    if (!text) return '';
    return String(text).replace(/[_*[\]()~`>#+\-=|{}.!]/g, '\\$&');
  };

  const messageParts = [
    "\\#Ğ´Ğ¸ÑÑ‚Ñ€Ğ¸Ğ±ÑƒÑ†Ğ¸Ñ *ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°ÑĞ²ĞºĞ° Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ°*\\!",
    "",
    "ğŸ“ *ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ*",
    `â–¸ â„–: ${escapeMd(data.contractNumber)}`,
    `â–¸ Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ğ°Ñ€: ${escapeMd(data.licensorName)}`,
    `â–¸ ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ğ¸Ğ¼: ${escapeMd(data.pseudonym || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}`,
    `â–¸ Ğ¢Ğ°Ñ€Ğ¸Ñ„: ${escapeMd(data.tariff)}`,
    `â–¸ Ğ¢Ğ¸Ğ¿ Ñ€ĞµĞ»Ğ¸Ğ·Ğ°: ${escapeMd(data.releaseType || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}`,
    `â–¸ Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ»Ğ¸Ğ·Ğ°: ${escapeMd(data.releaseDate || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°')}`,
    "",
    "ğŸµ *ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ*",
    `â–¸ ĞĞ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: ${escapeMd(data.workTitle || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾')}`,
    `â–¸ ĞĞ²Ñ‚Ğ¾Ñ€ Ğ¼ÑƒĞ·Ñ‹ĞºĞ¸: ${escapeMd(data.musicAuthor)}`,
    `â–¸ ĞĞ²Ñ‚Ğ¾Ñ€ Ñ‚ĞµĞºÑÑ‚Ğ°: ${escapeMd(data.lyricsAuthor)}`,
    "",
    "ğŸ“ *ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹*",
    `â–¸ Email: ${escapeMd(data.email || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}`,
    `â–¸ Ğ¡Ğ²ÑĞ·ÑŒ: ${escapeMd(data.contact || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}`,
    "",
    `ğŸ“„ [ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ](${escapeMd(data.sheetUrl)})`
  ];

  return messageParts.join("\n");
}

function buildPromoMessage(data) {
  const escapeMd = (text) => {
    if (!text) return '';
    return String(text).replace(/[_*[\]()~`>#+\-=|{}.!]/g, '\\$&');
  };

  const messageParts = [
    "\\#Ğ¿Ğ¸Ñ‚Ñ‡Ğ¸Ğ½Ğ³ *ĞĞ¾Ğ²Ğ°Ñ Ğ·Ğ°ÑĞ²ĞºĞ° Ğ½Ğ° Ğ¿Ñ€Ğ¾Ğ¼Ğ¾*\\!",
    "",
    `â–¸ Ğ¢Ğ¸Ğ¿: ${escapeMd(data.promoType)}`,
    `â–¸ ĞÑ€Ñ‚Ğ¸ÑÑ‚ Ğ¸ Ğ½Ğ°Ğ·Ğ²Ğ°Ğ½Ğ¸Ğµ: ${escapeMd(data.artistAndTitle || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾')}`,
    `â–¸ Ğ¡ÑÑ‹Ğ»ĞºĞ°: ${escapeMd(data.releaseLink || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°')}`,
    `â–¸ UPC: ${escapeMd(data.upcOrName || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}`,
    `â–¸ Ğ”Ğ°Ñ‚Ğ° Ñ€ĞµĞ»Ğ¸Ğ·Ğ°: ${escapeMd(data.releaseDate || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ°')}`,
    `â–¸ Ğ–Ğ°Ğ½Ñ€: ${escapeMd(data.genre || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}`,
    `â–¸ Ğ¤Ğ¾ĞºÑƒÑ\\-Ñ‚Ñ€ĞµĞº: ${escapeMd(data.focusTrack || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}`,
    `â–¸ ĞšĞ¾Ğ½Ñ‚Ğ°ĞºÑ‚Ñ‹: ${escapeMd(data.contactInfo || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ñ‹')}`,
    "",
    `ğŸ“„ [ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ](${escapeMd(data.sheetUrl)})`
  ];

  return messageParts.join("\n");
}

function buildPromoCodeMessage(data) {
  const escapeMd = (text) => {
    if (!text) return '';
    return String(text).replace(/[_*[\]()~`>#+\-=|{}.!]/g, '\\$&');
  };

  const discountText = data.discountType === 'percent'
    ? `${data.discountValue}%`
    : `${data.discountValue} â‚½`;

  const messageParts = [
    "\\#Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´ *Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´*\\!",
    "",
    `â–¸ ID: ${escapeMd(data.id)}`,
    `â–¸ ĞšĞ¾Ğ´: \`${escapeMd(data.code)}\``,
    `â–¸ Ğ¡ĞºĞ¸Ğ´ĞºĞ°: ${escapeMd(discountText)}`,
    `â–¸ ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ: ${escapeMd(data.description || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾')}`,
    "",
    `ğŸ“„ [ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†Ñƒ](${escapeMd(data.sheetUrl)})`
  ];

  return messageParts.join("\n");
}

function buildDocumentMessage(data) {
  const escapeMd = (text) => {
    if (!text) return '';
    return String(text).replace(/[_*[\]()~`>#+\-=|{}.!]/g, '\\$&');
  };

  const messageParts = [
    "\\#Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ *Ğ”Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€ ÑĞ¾Ğ·Ğ´Ğ°Ğ½*\\!",
    "",
    `â–¸ â„–: ${escapeMd(data.contractNumber)}`,
    `â–¸ Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ğ°Ñ€: ${escapeMd(data.licensorName)}`,
    `â–¸ ĞŸÑĞµĞ²Ğ´Ğ¾Ğ½Ğ¸Ğ¼: ${escapeMd(data.pseudonym || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½')}`,
    `â–¸ ĞŸÑ€Ğ¾Ğ¸Ğ·Ğ²ĞµĞ´ĞµĞ½Ğ¸Ğµ: ${escapeMd(data.workTitle || 'Ğ½Ğµ ÑƒĞºĞ°Ğ·Ğ°Ğ½Ğ¾')}`,
    "",
    `ğŸ“„ [ĞÑ‚ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€](${escapeMd(data.docUrl)})`
  ];

  return messageParts.join("\n");
}

function sendToTelegramAPI(message) {
  const url = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`;

  const chatIdsToTry = [
    TELEGRAM_CONFIG.CHAT_ID,
    `-100${TELEGRAM_CONFIG.CHAT_ID}`,
    `@${TELEGRAM_CONFIG.CHAT_ID}`
  ];

  let lastError;

  for (const chatId of chatIdsToTry) {
    try {
      const payload = {
        chat_id: chatId,
        text: message,
        parse_mode: "MarkdownV2",
        disable_web_page_preview: false
      };

      // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ÑĞµĞ¼ thread_id ĞµÑĞ»Ğ¸ ÑƒĞºĞ°Ğ·Ğ°Ğ½
      if (TELEGRAM_CONFIG.THREAD_ID) {
        payload.message_thread_id = TELEGRAM_CONFIG.THREAD_ID;
      }

      const response = UrlFetchApp.fetch(url, {
        method: "post",
        contentType: "application/json",
        payload: JSON.stringify(payload),
        muteHttpExceptions: true
      });

      const responseData = JSON.parse(response.getContentText());
      if (responseData.ok) return responseData;

      lastError = responseData.description;
    } catch (e) {
      lastError = e.message;
    }
  }

  throw new Error(`Telegram API: ${lastError || "ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğµ"}`);
}

function sendDebugInfo(text) {
  if (!TELEGRAM_CONFIG.DEBUG_MODE || !TELEGRAM_CONFIG.BOT_TOKEN || !TELEGRAM_CONFIG.CHAT_ID) {
    return;
  }

  try {
    const debugUrl = `https://api.telegram.org/bot${TELEGRAM_CONFIG.BOT_TOKEN}/sendMessage`;
    const payload = {
      chat_id: TELEGRAM_CONFIG.CHAT_ID,
      text: "ğŸ›  DEBUG:\n" + text,
      parse_mode: "MarkdownV2"
    };

    if (TELEGRAM_CONFIG.THREAD_ID) {
      payload.message_thread_id = TELEGRAM_CONFIG.THREAD_ID;
    }

    UrlFetchApp.fetch(debugUrl, {
      method: "post",
      contentType: "application/json",
      payload: JSON.stringify(payload),
      muteHttpExceptions: true
    });
  } catch (e) {
    Logger.log("ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ debug info: " + e);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ĞĞ”ĞœĞ˜Ğ-ĞŸĞĞĞ•Ğ›Ğ¬: Ğ§Ñ‚ĞµĞ½Ğ¸Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function listSheetRows(sheetParam, limit) {
  initializeSheets();

  const normalized = String(sheetParam || '').toLowerCase().trim();
  let sheetName = sheetParam;
  let sheetType = 'unknown';

  if (normalized === 'distributions' || normalized === 'distribution' || normalized === 'Ğ´Ğ¸ÑÑ‚Ñ€Ğ¸Ğ±ÑƒÑ†Ğ¸Ñ') {
    sheetName = DISTRIBUTION_SHEET_NAME;
    sheetType = 'distribution';
  } else if (normalized === 'promos' || normalized === 'promo' || normalized === 'Ğ¿Ñ€Ğ¾Ğ¼Ğ¾') {
    sheetName = PROMO_SHEET_NAME;
    sheetType = 'promo';
  } else if (normalized === 'promocodes' || normalized === 'promo_codes' || normalized === 'Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹') {
    sheetName = PROMO_CODES_SHEET_NAME;
    sheetType = 'promocodes';
  }

  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(sheetName);
  if (!sheet) throw new Error('Sheet "' + sheetName + '" not found');

  const data = sheet.getDataRange().getValues();
  if (!data || data.length < 2) return [];

  const headers = data[0];
  let rows = data.slice(1);
  if (limit && limit > 0) rows = rows.slice(-limit);

  if (sheetType === 'distribution') {
    return rows.map((r, idx) => {
      const obj = mapDistributionRow(headers, r);
      obj._row = idx + 2;
      return obj;
    });
  }
  if (sheetType === 'promo') {
    return rows.map((r, idx) => {
      const obj = mapPromoRow(headers, r);
      obj._row = idx + 2;
      return obj;
    });
  }
  if (sheetType === 'promocodes') {
    return rows.map((r, idx) => {
      const obj = mapPromoCodeRow(headers, r);
      obj._row = idx + 2;
      return obj;
    });
  }

  return rows.map((r, idx) => ({ index: idx + 1, values: r }));
}

function mapDistributionRow(headers, row) {
  const raw = rowToObject(headers, row);
  return {
    timestamp: normalizeDate(raw.timestamp),
    tariff: normalizeTariff(raw.tariff),
    releaseType: normalizeReleaseType(raw.release_type),
    trackCount: raw.track_count || 0,
    releaseName: raw.work_title || '',
    mainArtist: raw.pseudonym || '',
    releaseVersion: raw.release_version || '',
    releaseLink: raw.release_link || '',
    genre: raw.genre || '',
    language: raw.language || '',
    releaseDate: raw.release_date || '',
    coverLink: raw.cover_link || '',
    tiktokExcerpt: raw.tiktok_excerpt || '',
    tiktokFull: normalizeBool(raw.tiktok_full),
    yandexPreSave: normalizeBool(raw.yandex_presave),
    addKaraoke: normalizeBool(raw.karaoke),
    tracks: raw.tracks_json || '',
    fullName: raw.licensor_name || '',
    passportNumber: raw.passport_series_number || '',
    issuedBy: raw.passport_issued_by || '',
    issueDate: raw.passport_issue_date || '',
    bankDetails: raw.bank_details || '',
    email: raw.email || '',
    contactInfo: raw.contact || '',
    artistProfileLinks: raw.artist_profile_links || '',
    basePrice: normalizeNumber(raw.base_price),
    karaokePrice: normalizeNumber(raw.karaoke_price),
    totalPrice: normalizeNumber(raw.total_price),
    contractNumber: raw.contract_number || '',
    percentage: raw.percentage || '',
    contractStatus: raw.contract_status || '',
    musicAuthor: raw.music_author || '',
    lyricsAuthor: raw.lyrics_author || '',
    documentStatus: raw.document_status || ''
  };
}

function mapPromoRow(headers, row) {
  const raw = rowToObject(headers, row);
  return {
    timestamp: normalizeDate(raw.timestamp),
    promoType: normalizePromoType(raw.Type || raw.type),
    releaseLink: raw.release_link || '',
    upcOrName: raw.upc_or_name || '',
    releaseDate: raw.release_date || '',
    genre: raw.genre || '',
    focusTrack: raw.focus_track || '',
    additionalInfo: raw.additional_info || '',
    artistAndTitle: raw.artist_and_title || '',
    releaseDescription: raw.release_description || '',
    artistInfo: raw.artist_info || '',
    artistPhotos: raw.artist_photos || '',
    socialLinks: raw.social_links || '',
    contactInfo: raw.contact_info || '',
    status: raw.status || ''
  };
}

function mapPromoCodeRow(headers, row) {
  const raw = rowToObject(headers, row);
  return {
    id: raw.id || '',
    code: raw.code || '',
    discountType: raw.discount_type || 'percent',
    discountValue: raw.discount_value || 0,
    applicableTariffs: raw.applicable_tariffs || '',
    applicableReleaseTypes: raw.applicable_release_types || '',
    maxUses: raw.max_uses || 0,
    currentUses: raw.current_uses || 0,
    isActive: normalizeBool(raw.is_active),
    validFrom: raw.valid_from || '',
    validUntil: raw.valid_until || '',
    createdAt: raw.created_at || '',
    description: raw.description || ''
  };
}

function rowToObject(headers, row) {
  const obj = {};
  for (let i = 0; i < headers.length; i++) {
    obj[String(headers[i]).trim()] = row[i];
  }
  return obj;
}

function updateRowData(data) {
  const sheetParam = data.sheet || '';
  const rowNum = parseInt(String(data.row || ''), 10);
  const updates = data.updates || {};

  if (!sheetParam || !rowNum || !updates) {
    throw new Error('Missing update parameters');
  }

  const normalized = String(sheetParam || '').toLowerCase().trim();
  let sheetName = sheetParam;

  if (normalized === 'distributions' || normalized === 'distribution' || normalized === 'Ğ´Ğ¸ÑÑ‚Ñ€Ğ¸Ğ±ÑƒÑ†Ğ¸Ñ') {
    sheetName = DISTRIBUTION_SHEET_NAME;
  } else if (normalized === 'promos' || normalized === 'promo' || normalized === 'Ğ¿Ñ€Ğ¾Ğ¼Ğ¾') {
    sheetName = PROMO_SHEET_NAME;
  } else if (normalized === 'promocodes' || normalized === 'promo_codes' || normalized === 'Ğ¿Ñ€Ğ¾Ğ¼Ğ¾ĞºĞ¾Ğ´Ñ‹') {
    sheetName = PROMO_CODES_SHEET_NAME;
  }

  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(sheetName);
  if (!sheet) throw new Error('Sheet "' + sheetName + '" not found');

  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];

  Object.keys(updates).forEach(function(key) {
    let idx = headers.indexOf(key);
    if (idx < 0) {
      headers.push(key);
      sheet.getRange(1, headers.length).setValue(key);
      idx = headers.length - 1;
    }
    sheet.getRange(rowNum, idx + 1).setValue(updates[key]);
  });

  Logger.log(`Row ${rowNum} updated in ${sheetName}`);
}

function findRowById(sheet, headers, id) {
  if (!id) return -1;
  const idIdx = headers.indexOf('id');
  if (idIdx < 0) return -1;

  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return -1;

  const values = sheet.getRange(2, idIdx + 1, lastRow - 1, 1).getValues();
  for (let i = 0; i < values.length; i++) {
    if (String(values[i][0]) === String(id)) return i + 2;
  }
  return -1;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ’ÑĞ¿Ğ¾Ğ¼Ğ¾Ğ³Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function generateContractNumber() {
  const date = new Date();
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const random = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
  return `PFV-${year}${month}-${random}`;
}

function getTariffPercentage(tariff) {
  const percentages = {
    'basic': 55, 'Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹': 55, 'Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹': 55,
    'advanced': 70, 'ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹': 70, 'Ğ¿Ñ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹': 70,
    'premium': 90, 'ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼': 90, 'Ğ¿Ñ€ĞµĞ¼Ğ¸ÑƒĞ¼': 90,
    'platinum': 95, 'ĞŸĞ»Ğ°Ñ‚Ğ¸Ğ½ÑƒĞ¼': 95, 'Ğ¿Ğ»Ğ°Ñ‚Ğ¸Ğ½ÑƒĞ¼': 95
  };
  return percentages[tariff] || 55;
}

function getTariffName(tariff) {
  const names = {
    'basic': 'Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹',
    'advanced': 'ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹',
    'premium': 'ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼',
    'platinum': 'ĞŸĞ»Ğ°Ñ‚Ğ¸Ğ½ÑƒĞ¼'
  };
  return names[tariff] || tariff || 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½';
}

function getReleaseTypeName(type) {
  const names = {
    'single': 'Ğ¡Ğ¸Ğ½Ğ³Ğ»',
    'ep': 'EP',
    'album': 'ĞĞ»ÑŒĞ±Ğ¾Ğ¼'
  };
  return names[type] || type || 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½';
}

function getPromoTypeName(type) {
  const names = {
    'detailed': 'Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾',
    'weekly': 'Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾'
  };
  return names[type] || type || 'ĞĞµ ÑƒĞºĞ°Ğ·Ğ°Ğ½';
}

function normalizeDate(value) {
  if (value instanceof Date) return value.toISOString();
  return value;
}

function normalizeBool(value) {
  if (value === true || value === false) return value;
  if (value === 'Ğ”Ğ°' || value === 'yes' || value === 'true' || value === '1') return true;
  if (value === 'ĞĞµÑ‚' || value === 'no' || value === 'false' || value === '0') return false;
  return !!value;
}

function normalizeNumber(value) {
  if (typeof value === 'number') return value;
  if (typeof value === 'string') {
    const cleaned = value.replace(/[^\d.-]/g, '');
    const n = parseFloat(cleaned);
    return isNaN(n) ? 0 : n;
  }
  return 0;
}

function normalizeTariff(value) {
  const map = {
    'Ğ‘Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹': 'basic',
    'ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹': 'advanced',
    'ĞŸÑ€ĞµĞ¼Ğ¸ÑƒĞ¼': 'premium',
    'ĞŸĞ»Ğ°Ñ‚Ğ¸Ğ½ÑƒĞ¼': 'platinum'
  };
  return map[value] || value;
}

function normalizeReleaseType(value) {
  const map = {
    'Ğ¡Ğ¸Ğ½Ğ³Ğ»': 'single',
    'EP': 'ep',
    'ĞĞ»ÑŒĞ±Ğ¾Ğ¼': 'album'
  };
  return map[value] || value;
}

function normalizePromoType(value) {
  const map = {
    'Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾': 'detailed',
    'Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾': 'weekly'
  };
  return map[value] || value;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ñ Ğ´Ğ»Ñ Ñ€ÑƒÑ‡Ğ½Ğ¾Ğ³Ğ¾ Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¾Ğ²
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateExistingSheets() {
  Logger.log('Starting sheets update...');
  initializeSheets();
  Logger.log('Sheets updated successfully!');
  SpreadsheetApp.getActiveSpreadsheet().toast(
    'Ğ—Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ğ²ÑĞµÑ… Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ† Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹',
    'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾',
    3
  );
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¾Ğ³Ğ¾ Ğ¼ĞµĞ½Ñ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('ğŸ“„ PFVMUSIC')
    .addItem('ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ·Ğ°Ğ³Ğ¾Ğ»Ğ¾Ğ²ĞºĞ¸ Ñ‚Ğ°Ğ±Ğ»Ğ¸Ñ†', 'updateExistingSheets')
    .addSeparator()
    .addItem('ğŸ“ Ğ“ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ´Ğ¾Ğ³Ğ¾Ğ²Ğ¾Ñ€Ñ‹', 'generateLicenseDocuments')
    .addSeparator()
    .addItem('ğŸ“² Ğ¢ĞµÑÑ‚ Telegram (Ğ´Ğ¸ÑÑ‚Ñ€Ğ¸Ğ±ÑƒÑ†Ğ¸Ñ)', 'testTelegramDistribution')
    .addItem('ğŸ“² Ğ¢ĞµÑÑ‚ Telegram (Ğ¿Ñ€Ğ¾Ğ¼Ğ¾)', 'testTelegramPromo')
    .addToUi();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğµ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Telegram
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function testTelegramDistribution() {
  const testData = {
    contractNumber: 'TEST-2026-0001',
    licensorName: 'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞÑ€Ñ‚Ğ¸ÑÑ‚',
    pseudonym: 'Test MC',
    tariff: 'ĞŸÑ€Ğ¾Ğ´Ğ²Ğ¸Ğ½ÑƒÑ‚Ñ‹Ğ¹',
    releaseType: 'Ğ¡Ğ¸Ğ½Ğ³Ğ»',
    releaseDate: '2026-03-15',
    workTitle: 'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ Ñ‚Ñ€ĞµĞº',
    musicAuthor: 'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞÑ€Ñ‚Ğ¸ÑÑ‚',
    lyricsAuthor: 'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ñ‹Ğ¹ ĞÑ€Ñ‚Ğ¸ÑÑ‚',
    email: 'test@test.ru',
    contact: '+7 999 123 45 67',
    sheetUrl: SpreadsheetApp.getActiveSpreadsheet().getUrl()
  };
  
  try {
    sendDistributionNotification(testData);
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾!',
      'Telegram',
      5
    );
  } catch (error) {
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message,
      'Telegram',
      10
    );
  }
}

function testTelegramPromo() {
  const testData = {
    promoType: 'Ğ”ĞµÑ‚Ğ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¿Ñ€Ğ¾Ğ¼Ğ¾',
    artistAndTitle: 'Test Artist - Test Track',
    releaseLink: 'https://example.com',
    upcOrName: '1234567890',
    releaseDate: '2026-03-15',
    genre: 'Pop',
    focusTrack: 'Test Track',
    contactInfo: 'test@test.ru',
    sheetUrl: SpreadsheetApp.getActiveSpreadsheet().getUrl()
  };
  
  try {
    sendPromoNotification(testData);
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'Ğ¢ĞµÑÑ‚Ğ¾Ğ²Ğ¾Ğµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ğµ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¾!',
      'Telegram',
      5
    );
  } catch (error) {
    SpreadsheetApp.getActiveSpreadsheet().toast(
      'ĞÑˆĞ¸Ğ±ĞºĞ°: ' + error.message,
      'Telegram',
      10
    );
  }
}
