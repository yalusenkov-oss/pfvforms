# Инструкция по тестированию

## Запуск тестов

### Все тесты
```bash
npm test
```

### Тесты в watch режиме (автоматический перезапуск при изменениях)
```bash
npm test -- --watch
```

### Тесты с UI интерфейсом
```bash
npm run test:ui
```

### Тесты с покрытием кода
```bash
npm run test:coverage
```

## Структура тестов

Тесты находятся в файле `src/services/googleSheets.test.ts` и покрывают следующие функции:

### `prepareDistributionData`
- ✅ Подготовка данных для базового тарифа Single без караоке
- ✅ Расчет цены для Продвинутого тарифа EP с караоке
- ✅ Обработка `languageOther`
- ✅ Форматирование треков с feat артистами
- ✅ Обработка всех тарифов (Базовый, Продвинутый, Премиум, Платинум)
- ✅ Обработка всех типов релизов (Single, EP, Album)

### `preparePromoData`
- ✅ Подготовка данных для детального промо
- ✅ Подготовка данных для еженедельного промо
- ✅ Обработка fallback для неизвестного типа промо
- ✅ Обработка отсутствующих полей

### `submitToGoogleSheets`
- ⏭️ Ошибка при отсутствии URL (пропущен - требует сложного мокирования)
- ⏭️ Успешная отправка данных дистрибуции (пропущен - требует сложного мокирования)
- ⏭️ Успешная отправка данных промо (пропущен - требует сложного мокирования)
- ✅ Обработка ошибки сервера
- ✅ Повторная попытка при ошибке сети
- ⏭️ Обработка таймаута запроса (пропущен - требует сложного мокирования)

**Примечание:** Тесты отправки данных пропущены из-за сложности мокирования функции `getGoogleScriptUrl`, которая использует кэширование и несколько источников URL. Основная логика подготовки данных полностью покрыта тестами в `prepareDistributionData` и `preparePromoData`.

## Технические детали

### Используемые библиотеки
- **Vitest** - тестовый фреймворк
- **jsdom** - окружение для тестирования DOM API
- **@testing-library/jest-dom** - дополнительные матчеры для DOM

### Моки
Тесты используют моки для:
- `fetch` API - для симуляции HTTP запросов
- `window` объект - для тестирования получения URL из глобальных переменных
- Таймеры - для тестирования таймаутов и ретраев

## Добавление новых тестов

При добавлении новых функций в `googleSheets.ts`:

1. Создайте новый `describe` блок для функции
2. Добавьте тесты для основных сценариев использования
3. Добавьте тесты для граничных случаев и ошибок
4. Убедитесь, что тесты проходят: `npm test`

## Пример добавления теста

```typescript
describe('новаяФункция', () => {
  it('должен правильно обработать базовый случай', () => {
    const input = { /* тестовые данные */ };
    const result = новаяФункция(input);
    expect(result).toEqual({ /* ожидаемый результат */ });
  });

  it('должен обработать ошибку', () => {
    const input = { /* невалидные данные */ };
    expect(() => новаяФункция(input)).toThrow();
  });
});
```
